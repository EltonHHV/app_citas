{% extends "layout.html" %}

{% block content %}
{% set meses = {
'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo',
'April': 'Abril', 'May': 'Mayo', 'June': 'Junio',
'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre',
'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'
} %}

<h2>Calendario del Mes {{ meses[start_of_month.strftime('%B')] }} {{ start_of_month.strftime('%Y') }}</h2>


{% if tiene_sedes %}
<div class="alert alert-info mb-3">
  <i class="bi bi-info-circle"></i> Mostrando todas las citas
</div>
{% endif %}

<form method="POST" class="mb-3">
  <button type="submit" name="action" value="prev_month" class="btn btn-celeste">Mes Anterior</button>
  <button type="submit" name="action" value="next_month" class="btn btn-celeste">Mes Siguiente</button>
</form>

<link rel="stylesheet" href="{{ url_for('static', filename='css/ver_citas.css') }}">

<style>
  /* Estilos mejorados para las citas con colores por profesional */
  .cita {
    border-radius: 4px;
    margin-top: 5px;
    padding: 5px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }

  .cita:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    filter: brightness(0.95);
  }

  .cita-profesional {
    font-size: 0.75em;
    color: #333;
    font-weight: 500;
    display: block;
    margin-top: 2px;
  }
</style>

<div class="calendar">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Domingo</th>
        <th>Lunes</th>
        <th>Martes</th>
        <th>Mi√©rcoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
        <th>S√°bado</th>
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
      <tr>
        {% for day in week %}
        <td class="text-center" style="height: 150px; vertical-align: top;">
          <div class="{% if day.date == today %}highlighted-day{% endif %}">
            {{ day.date.day if day.date else '' }}
          </div>

          {% if day.date %}
          {% set fecha = day.date.strftime('%Y-%m-%d') %}
          {% set citas = ocupadas.get(fecha, []) %}

          {% for cita in citas %}
          {% set color_fondo = colores_doctores.get(cita.doctor, '#f1f1f1') if tiene_sedes else '#f1f1f1' %}
          <div class="cita" style="background-color: {{ color_fondo }};" data-id="{{ cita.id }}"
            data-paciente="{{ cita.paciente }}" data-motivo="{{ cita.motivo }}" data-celular="{{ cita.celular }}"
            data-doctor="{{ cita.doctor }}"
            data-fecha="{{ cita.fecha if cita.fecha is string else cita.fecha.strftime('%Y-%m-%d') }}"
            data-hora="{{ cita.hora }}" data-nacionalidad="{{ cita.nacionalidad }}"
            data-consultorio-nombre="{{ cita.consultorio_nombre }}" onclick="fillEditModal(this)">
            <strong>{{ cita.paciente }}</strong><br>
            {{ cita.hora }} - {{ cita.motivo }}
            {% if tiene_sedes %}
            <span class="cita-profesional">{{ cita.doctor }}</span>
            {% endif %}
          </div>
          {% endfor %}

          {% if citas|length == 0 %}
          <div class="no-cita" style="text-align: center; color: gray;">No hay citas</div>
          {% endif %}
          {% else %}
          <div></div>
          {% endif %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal de Edici√≥n / Cancelaci√≥n -->
<div class="modal fade" id="citaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="formCita">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reprogramar / Cancelar cita</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="modalCitaId">
          <!-- ‚úÖ NUEVO: Campo oculto para nacionalidad de la cita -->
          <input type="hidden" id="modalNacionalidad">
          <input type="hidden" id="modalConsultorioNombre">

          <div class="mb-3">
            <label for="modalPaciente" class="form-label">Paciente</label>
            <input type="text" id="modalPaciente" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label for="modalMotivo" class="form-label">Motivo</label>
            <input type="text" id="modalMotivo" name="motivo" class="form-control">
          </div>
          <div class="mb-3 d-flex align-items-center">
            <label for="modalCelular" class="form-label me-2">Celular</label>
            <input type="text" id="modalCelular" name="celular" class="form-control me-2">
            <!-- Bot√≥n personalizado -->
            <button type="button" class="btn" id="whatsappBtnPersonalizado" onclick="openWhatsAppPersonalizado()">
              <img src="{{ url_for('static', filename='recordatorio.png') }}" alt="WhatsApp"
                style="width: 50px; height: 50px;">
            </button>
          </div>
          <div class="mb-3">
            <label for="modalDoctor" class="form-label">
              {% if consultorio_id in [12, 14] %}
              Sede
              {% else %}
              Doctor
              {% endif %}
            </label>
            <select id="modalDoctor" name="doctor" class="form-select" required>
              {% for d in doctores_select %}
              <option value="{{ d['doctores'] }}">{{ d['doctores'] }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="modalFecha" class="form-label">Fecha</label>
            <input type="date" name="fecha" id="modalFecha" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="modalHora" class="form-label">Hora</label>
            <select name="hora" id="modalHora" class="form-select" required></select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" onclick="eliminarxd()">Eliminar cita</button>
          <button type="button" class="btn btn-primary" onclick="editarxd()">Guardar cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Cambio realizado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalMessage"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="reloadPage()">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ============================================================
  // CONFIGURACI√ìN MULTINACIONAL DE WHATSAPP
  // ============================================================

  const PAIS_CONFIG = {
    'Peru': {
      codigo: '51',
      digitos: 9,
      nombre: 'Per√∫',
      placeholder: '912345678'
    },
    'Chile': {
      codigo: '56',
      digitos: 9,
      nombre: 'Chile',
      placeholder: '912345678'
    }
  };

  // Obtener el nombre de la cl√≠nica y el consultorio_id desde el backend
  const nombreClinica = "{{ consultorio }}";  // Usamos el valor pasado del backend
  const consultorioId = "{{ consultorio_id }}";  // Usamos el ID del consultorio pasado del backend

  /**
   * ‚úÖ NUEVO: Obtiene la configuraci√≥n del pa√≠s de la cita actual
   */
  function getConfig() {
    const nacionalidad = document.getElementById("modalNacionalidad").value;
    const config = PAIS_CONFIG[nacionalidad];

    if (!config) {
      console.warn(`Nacionalidad "${nacionalidad}" no configurada. Usando Per√∫ por defecto.`);
      return PAIS_CONFIG['Peru'];
    }

    return config;
  }

  /**
   * ‚úÖ MODIFICADO: Formatea el n√∫mero seg√∫n el pa√≠s de la cita
   */
  function formatPhoneNumber(num) {
    const config = getConfig();  // ‚Üê Obtiene config din√°micamente
    num = num.replace(/[^\d]/g, '');

    // Si el n√∫mero ya tiene el c√≥digo de pa√≠s
    if (num.startsWith(config.codigo)) {
      const longitudEsperada = config.codigo.length + config.digitos;
      if (num.length === longitudEsperada) {
        return num;
      }
      return false;
    }

    // Si solo tiene los d√≠gitos locales
    if (num.length === config.digitos) {
      return config.codigo + num;
    }

    return false;
  }

  /**
   * ‚úÖ MODIFICADO: Abre WhatsApp con mensaje personalizado de recordatorio
   */
  function openWhatsAppPersonalizado() {
    const config = getConfig();

    // Obtener los datos directamente del modal
    var paciente = document.getElementById("modalPaciente").value;  // Nombre del paciente
    var motivo = document.getElementById("modalMotivo").value;  // Motivo de la cita
    var celular = document.getElementById("modalCelular").value;  // Celular del paciente
    var fechaCita = document.getElementById("modalFecha").value;  // Fecha de la cita
    var horaCita = document.getElementById("modalHora").value;  // Hora de la cita

    // Verificamos que el celular sea v√°lido
    var numero = formatPhoneNumber(celular);

    if (!numero) {
      alert(`Ingrese un n√∫mero v√°lido de ${config.nombre} (${config.digitos} d√≠gitos, ejemplo: ${config.placeholder})`);
      return;
    }

    // Verificamos que la fecha y hora sean v√°lidas
    if (!(fechaCita && horaCita)) {
      alert("Por favor, complete todos los campos de la cita.");
      return;
    }

    var partes = fechaCita.split("-");
    var anio = parseInt(partes[0], 10);
    var mes = parseInt(partes[1], 10) - 1;
    var dia = parseInt(partes[2], 10);
    var fechaCitaObj = new Date(anio, mes, dia);

    var hoy = new Date();
    var hoyObj = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
    var diffDias = Math.floor((fechaCitaObj - hoyObj) / (1000 * 60 * 60 * 24));

    if (diffDias < 0) {
      alert("No se puede enviar recordatorio para fechas pasadas.");
      return;
    }

    var diasSemana = ["domingo", "lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado"];
    var meses = [
      "enero", "febrero", "marzo", "abril", "mayo", "junio",
      "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
    ];
    var diaSemana = diasSemana[fechaCitaObj.getDay()];
    var diaNum = fechaCitaObj.getDate();
    var mesNombre = meses[fechaCitaObj.getMonth()];

    let fraseFecha = "";
    if (diffDias === 0) {
      fraseFecha = "HOY üóìÔ∏è";
    } else if (diffDias === 1) {
      fraseFecha = "MA√ëANA üóìÔ∏è";
    } else if (diffDias > 1) {
      fraseFecha = "el d√≠a " + diaSemana + " " + diaNum + " de " + mesNombre;
    } else {
      fraseFecha = "la fecha seleccionada";
    }

    // Condicional para el mensaje cuando el consultorio_id es 11
    var mensaje = "";
    if (consultorioId == 11) {
      mensaje = `¬°Hola, ${paciente}! üëã\n`;
      mensaje += `Somos ${nombreClinica} de la Dra. Leidy Murga G.\n`;
      mensaje += "Les informamos que NO ESTAMOS ACEPTANDO TARJETAS. Les pedimos que el pago sea realizado en efectivo, Plin, Yape o transferencia. Si es en efectivo, por favor, aseg√∫rese de que sea con montos exactos.\n\n";
      mensaje += `Te recordamos tu cita programada ${fraseFecha} a las ${horaCita}. üïí\n`;
      mensaje += "Favor de confirmar tu asistencia.\n\n";
      mensaje += "Direcci√≥n:\nCalle Talara / Gal. Jonas Shuan, 2do piso, Casma.";
    } else {
      mensaje = `¬°Hola, ${paciente}! üëãüòÄ\n`;
      mensaje += `Somos ${nombreClinica} te recordamos tu cita programada ${fraseFecha} a las ${horaCita}. üïí\n`;
      mensaje += `Motivo: ${motivo}\n`;
      mensaje += "Agradecemos tu puntualidad y confianza üòä. ¬°Nos vemos pronto! ‚ù§Ô∏è";
    }

    var urlMensaje = encodeURIComponent(mensaje);

    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    var whatsappUrl = isMobile
      ? "https://wa.me/" + numero + "?text=" + urlMensaje
      : "https://web.whatsapp.com/send?phone=" + numero + "&text=" + urlMensaje;

    console.log('Enviando recordatorio a:', numero);
    window.open(whatsappUrl, "_blank");
  }
</script>



<!-- Script para cargar horas disponibles -->
<script>
  // Configuraci√≥n de horarios disponibles
  const horarios = [
    '08:00 AM', '08:30 AM', '09:00 AM', '09:30 AM', '10:00 AM',
    '10:30 AM', '11:00 AM', '11:30 AM', '12:00 PM', '12:30 PM',
    '01:00 PM', '01:30 PM', '02:00 PM', '02:30 PM', '03:00 PM',
    '03:30 PM', '04:00 PM', '04:30 PM', '05:00 PM', '05:30 PM',
    '06:00 PM', '06:30 PM', '07:00 PM', '07:30 PM', '08:00 PM'
  ];

  // Variable global para saber si se manejan m√∫ltiples profesionales
  var tieneSedes = {{ tiene_sedes | tojson }};

  console.log(tieneSedes);

  let fechaOriginalCita = '';
  let horaOriginalCita = '';

  async function loadHorasModal(fecha, doctor, horaSel) {
    const select = document.getElementById('modalHora');
    select.innerHTML = '';
    const res = await fetch(`/horas_ocupadas?fecha=${fecha}&doctor=${encodeURIComponent(doctor)}`);
    const ocup = await res.json();
    const ocupadas = ocup.map(hora => hora.replace(" (ocupado)", ""));

    horarios.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h;
      opt.textContent = h;

      // Si la hora est√° ocupada
      if (ocupadas.includes(h) && h !== horaSel) {
        opt.style.color = '#dc3545'; // Color rojo para las horas ocupadas

        // Solo deshabilitar si NO tiene m√∫ltiples profesionales
        if (!tieneSedes) {
          opt.disabled = true;
        }
      }

      // Si es la misma hora que la cita actual, seleccionarla
      if (h === horaSel) {
        opt.selected = true;
      }

      select.appendChild(opt);
    });
  }

  /**
   * ‚úÖ MODIFICADO: Funci√≥n para cargar datos de la cita en el modal
   * Ahora incluye nacionalidad y consultorio
   */
  function fillEditModal(citaElement) {
    const id = citaElement.getAttribute('data-id');
    const paciente = citaElement.getAttribute('data-paciente');
    const motivo = citaElement.getAttribute('data-motivo');
    const celular = citaElement.getAttribute('data-celular');
    const doctor = citaElement.getAttribute('data-doctor');
    const fecha = citaElement.getAttribute('data-fecha');
    const hora = citaElement.getAttribute('data-hora');

    // ‚úÖ NUEVO: Obtener nacionalidad y consultorio
    const nacionalidad = citaElement.getAttribute('data-nacionalidad') || 'Peru';
    const consultorioNombre = citaElement.getAttribute('data-consultorio-nombre') || '{{ consultorio }}';

    document.getElementById('modalCitaId').value = id;
    document.getElementById('modalPaciente').value = paciente;
    document.getElementById('modalMotivo').value = motivo;
    document.getElementById('modalCelular').value = celular;
    document.getElementById('modalDoctor').value = doctor;
    document.getElementById('modalFecha').value = fecha;
    document.getElementById('modalHora').value = hora;

    // ‚úÖ CR√çTICO: Guardar nacionalidad y consultorio de la cita
    document.getElementById('modalNacionalidad').value = nacionalidad;
    document.getElementById('modalConsultorioNombre').value = consultorioNombre;

    // Log para debugging
    console.log('Cita cargada:', {
      id: id,
      paciente: paciente,
      nacionalidad: nacionalidad,
      consultorio: consultorioNombre
    });

    loadHorasModal(fecha, doctor, hora);

    new bootstrap.Modal(document.getElementById('citaModal')).show();
  }

  // Cargar las horas disponibles cuando la fecha cambie
  document.getElementById('modalFecha').addEventListener('change', function () {
    const fechaSeleccionada = this.value;
    const doctor = document.getElementById('modalDoctor').value;
    loadHorasModal(fechaSeleccionada, doctor, horaOriginalCita);
  });

  document.addEventListener('DOMContentLoaded', function () {
    // Establecer la fecha m√≠nima como el d√≠a de hoy
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('modalFecha').setAttribute('min', today);
  });


  // Funci√≥n para mostrar el modal de confirmaci√≥n
  function showConfirmationMessage(message) {
    document.getElementById('modalMessage').textContent = message;
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
  }

  // Funci√≥n para recargar la p√°gina despu√©s de la confirmaci√≥n
  function reloadPage() {
    location.reload();
  }

  // Funciones de edici√≥n y eliminaci√≥n usando AJAX
  function eliminarxd() {
    const citaId = document.getElementById('modalCitaId').value;
    const formData = new FormData();
    formData.append('id', citaId);

    fetch('/eliminarxd', {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showConfirmationMessage(data.message);
        }
      });
  }

  function editarxd() {
    const citaId = document.getElementById('modalCitaId').value;
    const nuevaFecha = document.getElementById('modalFecha').value;
    const nuevaHora = document.getElementById('modalHora').value;
    const nuevoMotivo = document.getElementById('modalMotivo').value;
    const nuevoCelular = document.getElementById('modalCelular').value;
    const nuevoDoctor = document.getElementById('modalDoctor').value;  // Nuevo: obtener el doctor seleccionado

    const formData = new FormData();
    formData.append('id', citaId);
    formData.append('fecha', nuevaFecha);
    formData.append('hora', nuevaHora);
    formData.append('motivo', nuevoMotivo);
    formData.append('celular', nuevoCelular);
    formData.append('doctor', nuevoDoctor);  // Nuevo: enviar el doctor seleccionado

    fetch('/editarxd', {
      method: 'POST',
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showConfirmationMessage(data.message);
        }
      });
  }

  // Listener para recargar horas cuando se cambie el doctor
  document.getElementById('modalDoctor').addEventListener('change', function () {
    const fechaSeleccionada = document.getElementById('modalFecha').value;
    const doctorSeleccionado = this.value;
    loadHorasModal(fechaSeleccionada, doctorSeleccionado, horaOriginalCita);
  });
</script>

{% endblock %}